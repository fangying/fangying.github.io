<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://kernelgo.org/theme/css/style.min.css?fc5adb95">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="author" content="Yori Fang" />

        <meta name="description" content="Linux MM Overvuew
" />
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="linux-mm, linux, " />

<meta property="og:title" content="Linux Memory Management Overview "/>
<meta property="og:url" content="https://kernelgo.org/drafts/linux-mm.html" />
<meta property="og:description" content="Linux MM Overvuew" />
<meta property="og:site_name" content="kernelgo" />
<meta property="og:article:author" content="Yori Fang" />
<meta property="og:article:published_time" content="2018-12-14T23:00:00+08:00" />
<meta property="og:article:modified_time" content="2018-12-14T23:00:00+08:00" />
<meta name="twitter:title" content="Linux Memory Management Overview ">
<meta name="twitter:description" content="Linux MM Overvuew">

        <title>Linux Memory Management Overview  · kernelgo
</title>
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-107392039-1', 'auto');
    ga('send', 'pageview');
</script>


    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="https://kernelgo.org/"><span class=site-name>kernelgo</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       https://kernelgo.org
                                    >Home</a>
                                </li>
                                <li ><a href="https://kernelgo.org/pages/about.html">About</a></li>
                                <li ><a href="https://kernelgo.org/categories.html">Categories</a></li>
                                <li ><a href="https://kernelgo.org/tags.html">Tags</a></li>
                                <li ><a href="https://kernelgo.org/archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="https://kernelgo.org/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="https://kernelgo.org/drafts/linux-mm.html">
                Linux Memory Management Overview
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <p>本文的目的是记录一下Linux内存管理的相关内容，用来督促自己主动学习一下内存管理的知识内容，加油！</p>
<h2>0.Linux内存管理的知识点</h2>
<p>《深入Linux内核架构》一书中将Linux内存管理的相关知识点归纳为5个Topic，即：</p>
<ol>
<li>内存中的物理内存页管理机制；</li>
<li>分配的大块内存的伙伴系统；</li>
<li>分配较小块内存的slab, slub和slob分配器；</li>
<li>分配非连续性内存块的vmalloc机制；</li>
<li>进程的虚拟内存管理。</li>
</ol>
<p>（kernel -&gt; Buddy System, Swap[zram, zcache], 虚实映射， RMAP， huge page， ZONE &amp; LRU）
硬件结构：MMU，L1Cache，内存一致性</p>
<p>Linux内存管理大图
https://www.cnblogs.com/pengdonglin137/p/4382403.html</p>
<h2>1.物理内存管理</h2>
<p>NUMA模型
内存结点：每个节点关联到系统的一个处理器上，再内核中表现为pg_data_t实例
内存域：每个内存结点又划分为不同的区域 (DMA NORMAL HIGHMEM)，一个结点最多由3个内存域构成。
页帧：代表系统内存的最小单位，标准大小是4KB，每个页帧对应一个page实例</p>
<p>初始化内存管理系统：</p>
<p>start_kernel -&gt; setup_arch -&gt; build_all_zonelists -&gt; setup_percpu_areas -&gt; mm_init -&gt; setup_per_cpu_pageset</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">memblock</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">current_limit</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">memblock_type</span><span class="w"> </span><span class="n">memory</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">memblock_type</span><span class="w"> </span><span class="n">reserved</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>

<p>体系结构相关的初始化
当内核已经载入内存，初始化的汇编执行后，内核需要执行哪些特定的步骤？</p>
<div class="highlight"><pre><span></span><code><span class="n">start_kernel</span><span class="w"></span>
<span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">setup_arch</span><span class="w"></span>
<span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">setup_per_cpu_areas</span><span class="w"></span>
<span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">build_all_zonelists</span><span class="w"></span>
<span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">mem_init</span><span class="w"></span>
<span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">setup_per_cpu_pageset</span><span class="w"></span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">setup_arch</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">setup_memory_map</span><span class="w"> </span><span class="p">(</span><span class="n">从bios读取可用内存情况</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">init_memory_mapping</span><span class="err">（</span><span class="n">建立直接内存映射</span><span class="err">）</span><span class="w"></span>
<span class="o">-&gt;</span><span class="w"> </span><span class="n">initmem_init</span><span class="w"></span>
<span class="w">  </span><span class="n">x86_numa_init</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">add_active_range</span><span class="w"></span>
<span class="w">  </span><span class="n">setup_bootmem_allocator</span><span class="w"></span>
<span class="o">-&gt;</span><span class="w"> </span><span class="n">paging_init</span><span class="w"></span>
<span class="w">  </span><span class="n">pagetable_init</span><span class="w"></span>
<span class="w">  </span><span class="n">zone_sizes_init</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">free_area_init_nodes</span><span class="w"></span>
</code></pre></div>

<p>注册活动的内存区域</p>
<p>add_active_range ： 在全局变量early_node_map中注册内存区域，相关数据结构</p>
<h3>1.2 Linux内核初期内存管理</h3>
<p>带着下面几个问题来学习：</p>
<ol>
<li>在内核启动的时候，Linux内核是如何知道系统中多有多大的内存空间？</li>
<li>在内核启动初期，Buddy分配器还未工作的时候，Linux是如何管理物理内存的？</li>
</ol>
<p><strong>内核是到底是如何获取物理内存的拓扑结构的呢？</strong>
从硬件的角度来看，随机存储器（Random Access Memory, RAM）是CPU直接交换数据的内部存储器。
现在绝大部分计算机都使用DDR（Dual Data Rate SDRAM）设备作为存储器。
DDR的初始化一般是又BIOS或者boot loader来完成的，然后BIOS或者boot loader将DDR的大小传递给内核。
在系统刚启动的时候RAM还处于不可用的状态，<strong>因为系统最早都是从ROM中启动的</strong>。
在X86平台上BIOS通过E820表报告系统物理内存情况，在ARM64平台上通过DTS来报告物理内存的大小给OS。</p>
<p>在内核刚启动的时候，伙伴系统还没开始工作，如何管理内存？
答案是<code>memblock</code>分配器（老的内核版本上使用的是<code>bootmem</code>分配器，现在由memblock分配器取而代之）。
<code>memblock</code>的内核补丁由<a href="https://lkml.org/lkml/2010/7/13/68">Yinghai Lu提供</a>。</p>
<p>在进一步介绍<code>memblock</code>之前，有必要先了解下Linux内核启动初期系统内存的使用情况<a href="https://blog.csdn.net/modianwutong/article/details/53162142">1</a>：
首先，内存中的某些部分是永久的分配给内核的，
比如内核代码段和数据段，ramdisk和fdt占用的空间等，它们是系统内存的一部分，但是不能被侵占，也不参与内存分配，称之为静态内存；
其次，GPU，Camera等都需要预留大量连续内存，这部分内存平时不用，但是系统必须提前预留好，称之为预留内存；
最后，内存的其余部分称之为动态内存，是需要内核管理的宝贵资源；</p>
<p>根据Linux内核启动初期的物理内存分配实际情况，memblock把物理内存划分为若干内存区，每个内存区域由一段连续的内存区间（Region）组成，
按使用类型分别放在memory，reserved和physmem三个集合（数组）中，
memory即动态内存的集合，reserved集合包括静态内存和预留内存，physmem即物理内存集合；</p>
<div class="highlight"><pre><span></span><code><span class="o">/**</span><span class="w"></span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">memblock_flags</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">region</span><span class="w"> </span><span class="n">attributes</span><span class="w"></span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">@</span><span class="n">MEMBLOCK_NONE</span><span class="p">:</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">special</span><span class="w"> </span><span class="n">request</span><span class="w"></span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">@</span><span class="n">MEMBLOCK_HOTPLUG</span><span class="p">:</span><span class="w"> </span><span class="n">hotpluggable</span><span class="w"> </span><span class="n">region</span><span class="w"></span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">@</span><span class="n">MEMBLOCK_MIRROR</span><span class="p">:</span><span class="w"> </span><span class="n">mirrored</span><span class="w"> </span><span class="n">region</span><span class="w"></span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">@</span><span class="n">MEMBLOCK_NOMAP</span><span class="p">:</span><span class="w"> </span><span class="n">don</span><span class="s1">&#39;t add to kernel direct mapping</span>
<span class="w"> </span><span class="o">*/</span><span class="w"></span>
<span class="k">enum</span><span class="w"> </span><span class="n">memblock_flags</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">MEMBLOCK_NONE</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0</span><span class="p">,</span><span class="w">  </span><span class="o">/*</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">special</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">*/</span><span class="w"></span>
<span class="w">        </span><span class="n">MEMBLOCK_HOTPLUG</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">0x1</span><span class="p">,</span><span class="w">  </span><span class="o">/*</span><span class="w"> </span><span class="n">hotpluggable</span><span class="w"> </span><span class="n">region</span><span class="w"> </span><span class="o">*/</span><span class="w"></span>
<span class="w">        </span><span class="n">MEMBLOCK_MIRROR</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="mh">0x2</span><span class="p">,</span><span class="w">  </span><span class="o">/*</span><span class="w"> </span><span class="n">mirrored</span><span class="w"> </span><span class="n">region</span><span class="w"> </span><span class="o">*/</span><span class="w"></span>
<span class="w">        </span><span class="n">MEMBLOCK_NOMAP</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="mh">0x4</span><span class="p">,</span><span class="w">  </span><span class="o">/*</span><span class="w"> </span><span class="n">don</span><span class="s1">&#39;t add to kernel direct mapping */</span>
<span class="p">};</span><span class="w"></span>

<span class="o">/**</span><span class="w"></span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="n">memblock_region</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">represents</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">region</span><span class="w"></span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">@</span><span class="n">base</span><span class="p">:</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">region</span><span class="w"></span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">@</span><span class="n">size</span><span class="p">:</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">region</span><span class="w"></span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">@</span><span class="n">flags</span><span class="p">:</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">region</span><span class="w"> </span><span class="n">attributes</span><span class="w"></span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">@</span><span class="n">nid</span><span class="p">:</span><span class="w"> </span><span class="n">NUMA</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="n">id</span><span class="w"></span>
<span class="w"> </span><span class="o">*/</span><span class="w"></span>
<span class="n">struct</span><span class="w"> </span><span class="n">memblock_region</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">base</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">enum</span><span class="w"> </span><span class="n">memblock_flags</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w"></span>
<span class="c1">#ifdef CONFIG_HAVE_MEMBLOCK_NODE_MAP</span><span class="w"></span>
<span class="w">        </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">nid</span><span class="p">;</span><span class="w"></span>
<span class="c1">#endif</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="o">/**</span><span class="w"></span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="n">memblock_type</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">collection</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">regions</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">certain</span><span class="w"> </span><span class="n">type</span><span class="w"></span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">@</span><span class="n">cnt</span><span class="p">:</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">regions</span><span class="w"></span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">@</span><span class="nb">max</span><span class="p">:</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">allocated</span><span class="w"> </span><span class="n">array</span><span class="w"></span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">@</span><span class="n">total_size</span><span class="p">:</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">regions</span><span class="w"></span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">@</span><span class="n">regions</span><span class="p">:</span><span class="w"> </span><span class="n">array</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">regions</span><span class="w"></span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">@</span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">symbolic</span><span class="w"> </span><span class="n">name</span><span class="w"></span>
<span class="w"> </span><span class="o">*/</span><span class="w"></span>
<span class="n">struct</span><span class="w"> </span><span class="n">memblock_type</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">unsigned</span><span class="w"> </span><span class="n">long</span><span class="w"> </span><span class="n">cnt</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">unsigned</span><span class="w"> </span><span class="n">long</span><span class="w"> </span><span class="nb">max</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">total_size</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">struct</span><span class="w"> </span><span class="n">memblock_region</span><span class="w"> </span><span class="o">*</span><span class="n">regions</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="o">/**</span><span class="w"></span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="n">memblock</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">memblock</span><span class="w"> </span><span class="n">allocator</span><span class="w"> </span><span class="n">metadata</span><span class="w"></span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">@</span><span class="n">bottom_up</span><span class="p">:</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">bottom</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">direction</span><span class="err">?</span><span class="w"></span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">@</span><span class="n">current_limit</span><span class="p">:</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">allocation</span><span class="w"> </span><span class="n">limit</span><span class="w"></span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">@</span><span class="n">memory</span><span class="p">:</span><span class="w"> </span><span class="n">usabe</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">regions</span><span class="w"></span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">@</span><span class="n">reserved</span><span class="p">:</span><span class="w"> </span><span class="n">reserved</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">regions</span><span class="w"></span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">@</span><span class="n">physmem</span><span class="p">:</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">memory</span><span class="w"></span>
<span class="w"> </span><span class="o">*/</span><span class="w"></span>
<span class="n">struct</span><span class="w"> </span><span class="n">memblock</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb nb-Type">bool</span><span class="w"> </span><span class="n">bottom_up</span><span class="p">;</span><span class="w">  </span><span class="o">/*</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">bottom</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">direction</span><span class="err">?</span><span class="w"> </span><span class="o">*/</span><span class="w"></span>
<span class="w">        </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">current_limit</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">struct</span><span class="w"> </span><span class="n">memblock_type</span><span class="w"> </span><span class="n">memory</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">struct</span><span class="w"> </span><span class="n">memblock_type</span><span class="w"> </span><span class="n">reserved</span><span class="p">;</span><span class="w"></span>
<span class="c1">#ifdef CONFIG_HAVE_MEMBLOCK_PHYS_MAP</span><span class="w"></span>
<span class="w">        </span><span class="n">struct</span><span class="w"> </span><span class="n">memblock_type</span><span class="w"> </span><span class="n">physmem</span><span class="p">;</span><span class="w"></span>
<span class="c1">#endif</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>

<p>内核还定义了一个memblock类型的全局变量，并为其做了初始化，如下：</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">memblock</span><span class="w"> </span><span class="n">memblock</span><span class="w"> </span><span class="n">__initdata_memblock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="n">regions</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">memblock_memory_init_regions</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="n">cnt</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">    </span><span class="cm">/* empty dummy entry */</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="n">max</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="n">INIT_MEMBLOCK_REGIONS</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="n">name</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;memory&quot;</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="p">.</span><span class="n">reserved</span><span class="p">.</span><span class="n">regions</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">memblock_reserved_init_regions</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">reserved</span><span class="p">.</span><span class="n">cnt</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">    </span><span class="cm">/* empty dummy entry */</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">reserved</span><span class="p">.</span><span class="n">max</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">INIT_MEMBLOCK_RESERVED_REGIONS</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">reserved</span><span class="p">.</span><span class="n">name</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;reserved&quot;</span><span class="p">,</span><span class="w"></span>

<span class="cp">#ifdef CONFIG_HAVE_MEMBLOCK_PHYS_MAP</span>
<span class="w">        </span><span class="p">.</span><span class="n">physmem</span><span class="p">.</span><span class="n">regions</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">memblock_physmem_init_regions</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">physmem</span><span class="p">.</span><span class="n">cnt</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">    </span><span class="cm">/* empty dummy entry */</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">physmem</span><span class="p">.</span><span class="n">max</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="n">INIT_PHYSMEM_REGIONS</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">physmem</span><span class="p">.</span><span class="n">name</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;physmem&quot;</span><span class="p">,</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">        </span><span class="p">.</span><span class="n">bottom_up</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">current_limit</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">MEMBLOCK_ALLOC_ANYWHERE</span><span class="p">,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>

<p>memblock的一些基本操作：</p>
<div class="highlight"><pre><span></span><code><span class="k">void</span><span class="w"> </span><span class="n">memblock_allow_resize</span><span class="p">(</span><span class="k">void</span><span class="p">);</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">memblock_add_node</span><span class="p">(</span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nid</span><span class="p">);</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">memblock_add</span><span class="p">(</span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">size</span><span class="p">);</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">memblock_remove</span><span class="p">(</span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">size</span><span class="p">);</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">memblock_free</span><span class="p">(</span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">size</span><span class="p">);</span><span class="w"></span>
<span class="n">static</span><span class="w"> </span><span class="n">inline</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="n">memblock_alloc</span><span class="p">(</span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w">  </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">align</span><span class="p">);</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">memblock_reserve</span><span class="p">(</span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">size</span><span class="p">);</span><span class="w"></span>
<span class="k">void</span><span class="w"> </span><span class="n">memblock_trim_memory</span><span class="p">(</span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">align</span><span class="p">);</span><span class="w"></span>
<span class="n">bool</span><span class="w"> </span><span class="n">memblock_overlaps_region</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="n">memblock_type</span><span class="w"> </span><span class="o">*</span><span class="k">type</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">size</span><span class="p">);</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">memblock_mark_hotplug</span><span class="p">(</span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">size</span><span class="p">);</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">memblock_clear_hotplug</span><span class="p">(</span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">size</span><span class="p">);</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">memblock_mark_mirror</span><span class="p">(</span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">size</span><span class="p">);</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">memblock_mark_nomap</span><span class="p">(</span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">size</span><span class="p">);</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">memblock_clear_nomap</span><span class="p">(</span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">size</span><span class="p">);</span><span class="w"></span>
</code></pre></div>

<p>内核在早期的初始化阶段，体系结构相关的初始化流程里会调用<code>memblock_add</code>和<code>memblock_add_node</code>
来添加内存layout信息。当<code>memblock</code>分配器建立起内存映射关系后，
就可以调用<code>memblock_phys_alloc</code>和<code>memblock_alloc</code>来分配物理内存和虚拟内存。
当内核启动到一定阶段之后，<code>memblock</code>分配器不再被需要，转而开始使用<code>buddy</code>分配器，
这时候内核会调用<code>mem_init</code>去释放所有的内存给<code>buddy page allocator</code>。</p>
<p>在X86平台上，BIOS通过E820 Table的方式向OS报告内存映射信息，OS通过调用BIOS function来从表里面get信息。
注：在IBM PC compatible计算机系统上，BIOS通过interrupt calls方式向bootloader提供一些必要的硬件信息，
在bootload阶段或者kernel启动早期的<strong>实模式阶段</strong>，都可以通过interrupt call（实际上是软中断）来调用bios接口<a href="https://en.wikipedia.org/wiki/BIOS_interrupt_call">1</a>，利用这些接口操作系统可以完成诸多功能，
例如：查询内存映射图的调用是：INT 0x15, EAX = 0xE820。
在X86上Linux内核初始化阶段<code>setup_arch</code>（arch/x86/kernel/setup.c）里会为系统预留特定的内存区域，
并调用<code>e820__memory_setup</code> -&gt; <code>memblock_alloc</code>等操作来完成<code>memblock</code>的初始化，
建立起早期的内核内存映射视图。</p>
<p>在ARM64平台上，通过FDT方式呈现去描述系统的内存映射关系。
扫描内存主要流程在是：setup_arch()-&gt;setup_machine_fdt()-&gt;early_init_dt_scan()-&gt;early_init_dt_scan_memory()
建立<code>memblock</code>内存映射的流程主要是在函数<code>arm64_memblock_init</code>里。</p>
<h2>2.分配大块内存的伙伴系统</h2>
<p>memblock分配器替代了bootmem分配器。</p>
<p>页表映射初始化： paging_init
paging_init负责建立只能用于内核的页表，用户空间无法访问。（__PAGE_OFFSET）</p>
<p>内存域节点数据初始化
该函数主要用来初始化素有pg_data_t和zone数据结构，参数max_zone_pfn记录了每个域最大pfn。节点的信息通过查找memblock表？</p>
<p>内存域初始化： __build_all_zonelists</p>
<p>该函数的主要工作是对活动的每个结点调用build_zonelists 建立内存域列表，build_zonelists建立内存分配的列表</p>
<p>伙伴系统的结构
free_area[MAX_ORDER] -&gt; </p>
<p>伙伴系统的初始化</p>
<p>伙伴系统的初始化发生在节点数据结构的初始化的时候，但此时空闲的内存为0，说明还不能使用，直到memblock分配器停用的时候。
free_area_init_node -&gt; free_area_init_core -&gt; init_currently_empty_zone -&gt; zone_init_free_lists</p>
<p>memblock 分配器的停用 （https://blog.csdn.net/modianwutong/article/details/53162142） 
memblock分配器停用后会释放所有的普通内存，返回给伙伴系统，高端内存单独 有独立的函数进行释放</p>
<p>mm_init -&gt;mem_init -&gt;free_all_bootmem -&gt; __free_pages -&gt; set_highmem_pages_init -&gt; __free_pages</p>
<p>碎片问题如何解决？ 不可以移动页，可回收页，可移动页</p>
<p>分配器API</p>
<p>页分配流程：</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="n">__alloc_pages_nodemask</span><span class="w"></span>
<span class="w">    </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">first_zones_zonelist</span><span class="w"></span>
<span class="w">      </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">get_page_from_freelist</span><span class="w"></span>
<span class="w">        </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">__alloc_pages_slowpath</span><span class="w"></span>
<span class="w">          </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">wake</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">kswapd</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">get_page_from_freelist</span><span class="w"></span>
<span class="w">          </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="n">compress</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">get_page_from_freelist</span><span class="w"></span>
<span class="w">          </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="n">claim</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">get_page_from_freelist</span><span class="w"></span>
<span class="w">          </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">kill</span><span class="w"> </span><span class="n">oom</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">get_page_from_freelist</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">sleep</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">while</span><span class="w"></span>
</code></pre></div>

<p>get_page_from_freelist 分配内存的实际函数，该函数遍历zonelist链表上的所有内存域按照优先顺序查找有没有空闲页，有就分配。
检查有没有内存页的函数 __zone_watermark_ok </p>
<div class="highlight"><pre><span></span><code><span class="cm">/*</span>
<span class="cm"> * Return true if free base pages are above &#39;mark&#39;. For high-order checks it</span>
<span class="cm"> * will return true of the order-0 watermark is reached and there is at least</span>
<span class="cm"> * one free page of a suitable size. Checking now avoids taking the zone lock</span>
<span class="cm"> * to check in the allocation paths if no pages are free.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kt">bool</span><span class="w"> </span><span class="nf">__zone_watermark_ok</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">zone</span><span class="w"> </span><span class="o">*</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">mark</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="kt">int</span><span class="w"> </span><span class="n">classzone_idx</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">alloc_flags</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="kt">long</span><span class="w"> </span><span class="n">free_pages</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mark</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">o</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">alloc_harder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">alloc_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ALLOC_HARDER</span><span class="o">|</span><span class="n">ALLOC_OOM</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* free_pages may go negative - that&#39;s OK */</span><span class="w"></span>
<span class="w">    </span><span class="n">free_pages</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">order</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">alloc_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ALLOC_HIGH</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">min</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">min</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * If the caller does not have rights to ALLOC_HARDER then subtract</span>
<span class="cm">     * the high-atomic reserves. This will over-estimate the size of the</span>
<span class="cm">     * atomic reserve but it avoids a search.</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">alloc_harder</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">free_pages</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">z</span><span class="o">-&gt;</span><span class="n">nr_reserved_highatomic</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * OOM victims can try even harder than normal ALLOC_HARDER</span>
<span class="cm">         * users on the grounds that it&#39;s definitely going to be in</span>
<span class="cm">         * the exit path shortly and free memory. Any allocation it</span>
<span class="cm">         * makes during the free path will be small and short-lived.</span>
<span class="cm">         */</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">alloc_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ALLOC_OOM</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">min</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">min</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"></span>
<span class="w">            </span><span class="n">min</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">min</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>


<span class="cp">#ifdef CONFIG_CMA</span>
<span class="w">    </span><span class="cm">/* If allocation can&#39;t use CMA areas don&#39;t use free CMA pages */</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">alloc_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ALLOC_CMA</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="n">free_pages</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">zone_page_state</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">NR_FREE_CMA_PAGES</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Check watermarks for an order-0 allocation request. If these</span>
<span class="cm">     * are not met, then a high-order request also cannot go ahead</span>
<span class="cm">     * even if a suitable page happened to be free.</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">free_pages</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">min</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z</span><span class="o">-&gt;</span><span class="n">lowmem_reserve</span><span class="p">[</span><span class="n">classzone_idx</span><span class="p">])</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* If this is an order-0 request then the watermark is fine */</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">order</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* For a high-order request, check at least one suitable page is free */</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">order</span><span class="p">;</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_ORDER</span><span class="p">;</span><span class="w"> </span><span class="n">o</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">free_area</span><span class="w"> </span><span class="o">*</span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">z</span><span class="o">-&gt;</span><span class="n">free_area</span><span class="p">[</span><span class="n">o</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">mt</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">nr_free</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">mt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">mt</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MIGRATE_PCPTYPES</span><span class="p">;</span><span class="w"> </span><span class="n">mt</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">[</span><span class="n">mt</span><span class="p">]))</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="cp">#ifdef CONFIG_CMA</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">alloc_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ALLOC_CMA</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">[</span><span class="n">MIGRATE_CMA</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">alloc_harder</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">[</span><span class="n">MIGRATE_HIGHATOMIC</span><span class="p">]))</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>寻找伙伴：当释放一块内存时，系统需要判断该内存块是否能和其他伙伴系统合并成更高阶的内存。</p>
<div class="highlight"><pre><span></span><code>    <span class="k">while</span><span class="ss">(</span><span class="nv">order</span> <span class="o">&lt;</span> <span class="nv">MAX_ORDER</span> <span class="o">-</span> <span class="mi">1</span><span class="ss">)</span> {
        <span class="nv">buddy_idx</span> <span class="o">=</span> <span class="nv">__find_buddy_index</span>
        <span class="nv">buddy</span> <span class="o">=</span> <span class="nv">page</span> <span class="o">+</span> <span class="nv">xxx</span>
    }

    <span class="nv">__find_buddy_index</span>
</code></pre></div>

<p>内核中不连续页的分配 vmalloc
* vmalloc用于分配虚拟地址连续，物理地址未必连续的内存，使用标志 ZONE_HIGHMEM，倾向分配高端内存
内核为跟踪哪些子区域被使用哪些内存域空闲，使用vm_struct结构管理映射区域</p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>

<p>内存释放： __free_pages</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="n">__free_pages</span><span class="w"></span>
<span class="w">    </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">single</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="o">?</span><span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">per</span><span class="o">-</span><span class="n">cpu</span><span class="w"> </span><span class="n">cache</span><span class="w"></span>
<span class="w">    </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">slab</span><span class="w"> </span><span class="n">system</span><span class="w"></span>
</code></pre></div>

<h2>3.分配较小块内存的slab, slub和slob分配器</h2>
<h2>4.分配非连续性内存块的vmalloc机制</h2>
<h2>5.进程的虚拟内存管理</h2>
<p>https://blog.csdn.net/modianwutong/article/details/53162142</p>
<p>https://www.cnblogs.com/ronnydm/default.html?page=2</p>


             
 
            
            
            







            <hr/>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2018-12-14T23:00:00+08:00">Fri 14 December 2018</time>

            <h4>Category</h4>
            <a class="category-link" href="https://kernelgo.org/categories.html#linux-ref">linux</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="https://kernelgo.org/tags.html#linux-mm-ref">linux-mm
</a></li>
            </ul>
<h4>Contact</h4>
<div id="sidebar-social-link">
    <a href="https://github.com/fangying" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitHub" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1B1817"/><path fill="#fff" d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
    </a>
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>
    <div>
        <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title"> kernelgo"</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="https://kernelgo.org" property="cc:attributionName" rel="cc:attributionURL">Yori Fang</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.
    </div>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="https://kernelgo.org/theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>