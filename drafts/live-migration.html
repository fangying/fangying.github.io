<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://kernelgo.org/theme/css/style.min.css?fc5adb95">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="author" content="Yori Fang" />

        <meta name="description" content="QEMU live migration
" />
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="live-migration, virtualization, " />

<meta property="og:title" content="QEMU Live Migration Internal "/>
<meta property="og:url" content="https://kernelgo.org/drafts/live-migration.html" />
<meta property="og:description" content="QEMU live migration" />
<meta property="og:site_name" content="kernelgo" />
<meta property="og:article:author" content="Yori Fang" />
<meta property="og:article:published_time" content="2020-02-23T23:00:00+08:00" />
<meta property="og:article:modified_time" content="2020-02-23T23:00:00+08:00" />
<meta name="twitter:title" content="QEMU Live Migration Internal ">
<meta name="twitter:description" content="QEMU live migration">

        <title>QEMU Live Migration Internal  · kernelgo
</title>
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-107392039-1', 'auto');
    ga('send', 'pageview');
</script>


    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="https://kernelgo.org/"><span class=site-name>kernelgo</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       https://kernelgo.org
                                    >Home</a>
                                </li>
                                <li ><a href="https://kernelgo.org/pages/about.html">About</a></li>
                                <li ><a href="https://kernelgo.org/categories.html">Categories</a></li>
                                <li ><a href="https://kernelgo.org/tags.html">Tags</a></li>
                                <li ><a href="https://kernelgo.org/archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="https://kernelgo.org/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="https://kernelgo.org/drafts/live-migration.html">
                QEMU Live Migration Internal
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <p>虚拟机热迁移技术（VM live migration）是指在虚拟机正在运行的时候，
在不影响虚拟机正常业务执行的情况下将虚拟机从一个物理机迁移到另外一台物理机上的一种技术方案。
经过多年的发展，虚拟机热迁移技术逐渐成熟，已经在云计算IaaS运维里面得到大规模应用和广泛实践。
热迁移技术可以说是整个虚拟化技术中心最为复杂的特性，其中涉及的知识点相当多。
本文旨在整理一下和虚拟机热迁移相关的一些技术细节，为对虚拟化感兴趣的人提供一些参考，
同时也作为我个人的知识学习和整理。</p>
<p>本文主要包含了以下几个关于热迁移的Topic：</p>
<ol>
<li>qemu-kvm虚拟机热迁移框架</li>
<li>libvirt热迁移流程</li>
<li>qemu热迁移关键流程</li>
<li>kvm热迁移标脏，pml，大页内存</li>
<li>multifd热迁移，压缩热迁移，热迁移限速</li>
<li>userfault和postcopy</li>
<li>vhost-user脏页跟踪</li>
</ol>
<p><strong>本文由于涵盖面较大，可能有点长，也有点啰嗦，我猜测一般人没有那个耐心看完的，除非你不是一般人</strong>。</p>
<h2>1. qemu-kvm虚拟机热迁移原理和框架</h2>
<p>基本流程：
Libvirt，qemu，kvm</p>
<p>基本数据结构：
SaveStateEntry, SaveVMHandler</p>
<p>VMState </p>
<p>https://wiki.qemu.org/File:Postcopyflow.png</p>
<p>kvm标脏流程，pml原理，大页内存如何标脏，multifd，极速热迁移</p>
<h2>2. Libvirt热迁移</h2>
<p>根据通信控制模式的不同，Libvirt热迁移可以分为3种类型：</p>
<ul>
<li>受控直接热迁移（Managed direct migration）；</li>
<li>受控点对点热迁移（Managed peer to peer migration）；</li>
<li>无控制直接迁移（Unmanaged direct migration）</li>
</ul>
<p>受控直接热迁移由libvirt客户端直接管理，客户端与两端的数据libvirt连接，
中间发生异常本地libvirtd反馈给客户端，再由客户端通知对端。
这种迁移方式的缺点在于libvirt客户端crash或者与libvirtd断开连接后，
造成迁移失败并且容易残留。</p>
<p>受控点对点迁移由libvirtd直接交互管理，libvirt客户端通知远端libvirtd发起热迁移，
之后由远端libvirtd与目的端libvirtd建立连接，并管理整个迁移过程。
这种迁移方式的优点在于libvirt客户端crash或者与源端libvirtd连接断开后，热迁移仍旧能够正常完成。</p>
<p>无控制直接热迁移则由Hypervisor上层管理程序完成控制，libvirt客户端通过Hypervisor管理程序初始化
迁移，之后由Hypervisor管理程序自行控制与目的端的迁移流程。</p>
<p>Libvirt迁移也一直不断在重构和演进当中，目前最完整的v3协议一共包含了5个阶段：</p>
<ul>
<li>Begin阶段    （源端）<ul>
<li>生成需要传递给对端的xml
— 生成需要传递给对端的cookie</li>
</ul>
</li>
<li>Prepare阶段  （目的端）<ul>
<li>为接受即将到来的VM做准备</li>
<li>生成传递给源端的可选cookie</li>
</ul>
</li>
<li>Perform阶段  （源端） <ul>
<li>开始迁移，并等待传送完成</li>
<li>生成传递给对端的可选cookie</li>
</ul>
</li>
<li>Finish阶段   （目的端）<ul>
<li>等待接受完成，并检查虚拟机状态</li>
<li>如果迁移失败则kill虚拟机，否则resume虚拟机</li>
</ul>
</li>
<li>Confirm     （源端）<ul>
<li>如果失败则resume虚拟机，否则kill虚拟机</li>
</ul>
</li>
</ul>
<h2>3. QEMU热迁移</h2>
<p>当libvirt下发qmp热迁移命令<code>qmp_migrate</code>的时候，QEMU会创建热迁移线程。</p>
<h3>3.1 Source Behavior</h3>
<p>Source下发热迁移，通过qmp命令来触发：</p>
<div class="highlight"><pre><span></span><code><span class="n">qmp_migrate</span><span class="w"> </span>
<span class="w">    </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">tcp_start_outgoing_migration</span><span class="w"> </span>
<span class="w">        </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">socket_start_outgoing_migration</span><span class="w"> </span>
<span class="w">            </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">migration_fd_connect</span>
<span class="w">                </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">multifd_save_setup</span>
<span class="w">                </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">qemu_thread_create</span>
<span class="w">                    </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">migration_thread</span>
</code></pre></div>

<p>QEMU 热迁移线程<code>migration_thread</code>负责整个QEMU热迁移的流程。
按照热迁移功能节点，可以划分成4个Step：</p>
<ul>
<li>Step1：初始化阶段，发送初始化消息和热配参数到目的端；</li>
<li>Step2：setup准备阶段，创建脏页位图并开始全局标脏（包括内存和块设备的）；</li>
<li>Step3：内存、块设备迭代拷贝阶段；</li>
<li>Step4：vCPU暂停和设备状态保存。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">migration_thread</span><span class="w"> </span>
<span class="p">{</span>
<span class="w">    </span><span class="nl">Step1</span><span class="p">:</span><span class="w"> </span><span class="n">qemu_savevm_state_header</span><span class="w">  </span><span class="n">发送魔术字0x5145564d和热迁移配置参数到目的端</span>

<span class="w">    </span><span class="nl">Step2</span><span class="p">:</span><span class="w"> </span><span class="n">qemu_savevm_state_setup</span><span class="w">   </span><span class="n">热迁移准备阶段</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">FOREACH</span><span class="w"> </span><span class="n">SaveStateEntry</span>
<span class="w">            </span><span class="n">save_section_header</span><span class="w">          </span><span class="n">添加section</span><span class="w"> </span><span class="n">header</span>

<span class="w">            </span><span class="cm">/* 内存传输准备阶段，定义好savevm_ram_handlers*/</span>
<span class="w">            </span><span class="n">ram_save_setup</span>
<span class="w">                </span><span class="n">ram_init_all</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">ram_init_bitmaps</span><span class="w">    </span><span class="n">初始化每个RAMblock的bitmap</span>
<span class="w">                    </span><span class="n">memory_global_dirty_log_start</span><span class="w">    </span><span class="n">开启全局标脏</span>
<span class="w">                    </span><span class="n">migration_bitmap_sync_precopy</span><span class="w">    </span><span class="n">开启内存标脏</span>
<span class="w">                        </span><span class="n">RAMBLOCK_FOREACH_MIGRATABLE</span><span class="w"> </span><span class="n">遍历所有的migratable</span><span class="w"> </span><span class="n">RAMBlock</span>
<span class="w">                        </span><span class="n">发送RAMBlock信息</span><span class="w">    </span>
<span class="w">            </span><span class="p">}</span>


<span class="w">        </span><span class="cm">/* 存储传输准备阶段 */</span><span class="w">  </span><span class="n">block_save_setup</span>
<span class="w">        </span><span class="n">init_blk_migration</span>
<span class="w">            </span><span class="n">初始化blk_mig_state</span><span class="err">，</span><span class="n">统计磁盘块信息</span>
<span class="w">        </span><span class="n">set_dirty_tracking</span>
<span class="w">            </span><span class="n">创建磁盘脏页位图</span>

<span class="w">        </span><span class="n">save_section_footer</span><span class="w">          </span><span class="c1">//添加section footer</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nl">Step3</span><span class="p">:</span><span class="w"> </span><span class="n">内存</span><span class="o">/</span><span class="n">磁盘迭代拷贝传输阶段</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="n">migraiton_is_active</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">migration_iteration_run</span><span class="w"> </span><span class="cm">/* 每一轮迭代先查询脏页信息，然后做一轮传送 */</span>
<span class="w">            </span><span class="n">qemu_savevm_state_pending</span><span class="w">   </span><span class="c1">//计算需要传输的剩余数据大小</span>
<span class="w">                </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">save_live_pending</span><span class="w">  </span><span class="c1">//脏页位图同步，这个过程中要拿到QEMU大锁的</span>
<span class="w">            </span><span class="n">qemu_savevm_state_iterate</span>
<span class="w">                </span><span class="n">FOREACH</span><span class="w"> </span><span class="n">SaveStateEntry</span><span class="p">(</span><span class="n">savevm_state</span><span class="p">)</span>
<span class="w">                    </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">save_live_iterate</span>
<span class="w">                    </span><span class="c1">// 发送内存数据，存储数据到目的端</span>
<span class="w">            </span><span class="n">migration_rate_limit</span><span class="w"> </span><span class="cm">/* 热迁移限速，QOS */</span>
<span class="w">            </span><span class="c1">// if pending_size &lt; threshold_size 剩下的内容不多了</span>
<span class="w">            </span><span class="n">migration_completion</span><span class="w">  </span><span class="c1">// 进入热迁移完成阶段</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nl">Step4</span><span class="p">:</span><span class="w"> </span><span class="n">CPU停机和设备状态保存</span>
<span class="w">    </span><span class="n">migraiton_completion</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">vm_stop_force_state</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">RUN_STATE_FINISH_MIGRATE</span><span class="w">  </span><span class="c1">// 运行状态切换，强制停机</span>
<span class="w">           </span><span class="n">vm_stop</span>
<span class="w">              </span><span class="n">do_vm_stop</span><span class="w">    </span><span class="cm">/* 将vcpu都pause住，并且将没有落盘的BlockIO处理完 */</span>
<span class="w">        </span><span class="n">qemu_savevm_state_complete_precopy</span><span class="w">   </span><span class="cm">/* 进入precopy的完成阶段 */</span>
<span class="w">            </span><span class="n">cpu_synchronize_all_states</span><span class="w">       </span><span class="cm">/* 同步vcpu的状态* /</span>
<span class="cm">        qemu_savevm_state_complete_precopy_non_iterable    // 对于precopy的设备状态同步</span>
<span class="cm">            {</span>
<span class="cm">                FOREACH SaveStateEntry {</span>
<span class="cm">                /* 每个qdev设备在realize的时候会注册自己的handler，device_set_realized */</span>
<span class="w">                    </span><span class="n">vmstate_save</span><span class="w">                             </span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4>3.1.1内存、块设备迭代拷贝</h4>
<h4>3.1.2设备状态的保存和恢复</h4>
<p>这里以virtio-blk设备为例，分析一下virtio-blk设备状态保存的具体实现。
设备状态是在停机后再保存,而且很明显也不需要迭代，qemu热迁移代码是一直在不断重构的，
现在是在<code>qemu_savevm_state_complete_precopy_non_iterable</code>函数中实现。</p>
<p><code>qemu_savevm_state_complete_precopy_non_iterable</code>中是个foreach循环，
会遍历每个设备注册进来的<code>SaveStateEntry</code>，调用设备自己注册的回调函数去保存设备
自己要保存的状态。每个设备状态是用一个预定义好的<code>json</code>对象格式来保存的，其大致结构为：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;page_size&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">4096</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;devices&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;virito-blk&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;instance_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;vmsd_name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;virtio-blk&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;version&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;fields&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p>如果还是不太clear，这里有一份实例可以参考一下：</p>
<p>https://github.com/qemu/qemu/blob/master/tests/vmstate-static-checker-data/dump1.json</p>
<p>其中<code>devices</code>是一个数组，每个设备是其中的一个数组元素。
对于每个<code>device</code>又定义了<code>name</code>,<code>instance_id</code>,<code>version</code>等属性，
每个设备有个<code>VMStateField</code>类型的<code>fileds</code>数组，用来保存设备要保存的内容，其内容也是转换为json对象格式。</p>
<p>有个关键的函数叫做<code>vmstate_save</code>，是单个设备状态保存的入口函数。</p>
<div class="highlight"><pre><span></span><code><span class="n">migration_completion</span>
<span class="o">-&gt;</span><span class="w"> </span><span class="n">qemu_savevm_state_complete_precopy</span>
<span class="o">-&gt;</span><span class="w"> </span><span class="n">qemu_savevm_state_complete_precopy_non_iterable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">QTAILQ_FOREACH</span><span class="w"> </span><span class="n">savevm_state</span><span class="p">.</span><span class="n">handlers</span><span class="w"> </span><span class="p">{</span><span class="w">    </span><span class="cm">/* 这里是循环遍历每个qdev设备，调用设备*/</span>
<span class="w">        </span><span class="n">vmstate_save</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 保存virtio-blk设备状态，有些legacy设备没有使用vmsd，即old_style</span>
<span class="w">            </span><span class="n">vmstate_save_old_style</span>
<span class="w">        </span><span class="n">vmstate_save_state</span><span class="w">    </span><span class="cm">/* 使用vmsd来保存设备状态的设备 */</span>
<span class="w">            </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">vmstate_save_state_v</span>
<span class="w">                </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">virtio_device_put</span>
<span class="w">                </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">virtio_save</span>
<span class="w">                    </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">virtio_blk_save_device</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">virtio</span><span class="o">-</span><span class="n">blk设备注册了VMStateDescription来保存要保存的设备状态</span><span class="err">。</span>
<span class="n">在hw</span><span class="o">/</span><span class="n">block</span><span class="o">/</span><span class="n">virtio</span><span class="o">-</span><span class="n">blk</span><span class="p">.</span><span class="n">c</span>
<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">VMStateDescription</span><span class="w"> </span><span class="n">vmstate_virtio_blk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">                                                                                                            </span>
<span class="w">    </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;virtio-blk&quot;</span><span class="p">,</span><span class="w">                                                       </span>
<span class="w">    </span><span class="p">.</span><span class="n">minimum_version_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">                                                    </span>
<span class="w">    </span><span class="p">.</span><span class="n">version_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">                                                            </span>
<span class="w">    </span><span class="p">.</span><span class="n">fields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">VMStateField</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w">                                                </span>
<span class="w">        </span><span class="n">VMSTATE_VIRTIO_DEVICE</span><span class="p">,</span><span class="w">                                                  </span>
<span class="w">        </span><span class="n">VMSTATE_END_OF_LIST</span><span class="p">()</span><span class="w">                                                   </span>
<span class="w">    </span><span class="p">},</span><span class="w">                                                                          </span>
<span class="p">};</span>
</code></pre></div>

<p>重点看下<code>vmstate_save</code>的关键实现，这个函数的主要功能就是将设备对象的状态保存下来。
如果设备对象的vmsd有<code>pre_save</code>这个hook，先调用<code>pre_save</code>执行设备状态保存之前的预处理，
接着遍历设备对象预定义的所有<code>field</code>，根据<code>filed</code>的类型（指针类型，结构体类型，其他基础类型）
按照特定的格式保存设备对象的状态到目的端，这个过程中会调用<code>field</code>自己的的<code>put</code>方法来保存。</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">VMStateInfo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">get</span><span class="p">)(</span><span class="n">QEMUFile</span><span class="w"> </span><span class="o">*</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">pv</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">VMStateField</span><span class="w"> </span><span class="o">*</span><span class="n">field</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">put</span><span class="p">)(</span><span class="n">QEMUFile</span><span class="w"> </span><span class="o">*</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">pv</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">VMStateField</span><span class="w"> </span><span class="o">*</span><span class="n">field</span><span class="p">,</span>
<span class="w">               </span><span class="n">QJSON</span><span class="w"> </span><span class="o">*</span><span class="n">vmdesc</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>

<p>再接着如果有<code>subsection</code>也保存一下，最后调用<code>post_save</code>执行设备状态保存后的一些处理工作。</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">vmstate_save_state_v</span><span class="p">(</span><span class="n">QEMUFile</span><span class="w"> </span><span class="o">*</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">VMStateDescription</span><span class="w"> </span><span class="o">*</span><span class="n">vmsd</span><span class="p">,</span>
<span class="w">                         </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">opaque</span><span class="p">,</span><span class="w"> </span><span class="n">QJSON</span><span class="w"> </span><span class="o">*</span><span class="n">vmdesc</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">version_id</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VMStateField</span><span class="w"> </span><span class="o">*</span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmsd</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">;</span>

<span class="w">    </span><span class="n">trace_vmstate_save_state_top</span><span class="p">(</span><span class="n">vmsd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vmsd</span><span class="o">-&gt;</span><span class="n">pre_save</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmsd</span><span class="o">-&gt;</span><span class="n">pre_save</span><span class="p">(</span><span class="n">opaque</span><span class="p">);</span>
<span class="w">        </span><span class="n">trace_vmstate_save_state_pre_save_res</span><span class="p">(</span><span class="n">vmsd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">error_report</span><span class="p">(</span><span class="s">&quot;pre-save failed: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">vmsd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vmdesc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">json_prop_str</span><span class="p">(</span><span class="n">vmdesc</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;vmsd_name&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">vmsd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">        </span><span class="n">json_prop_int</span><span class="p">(</span><span class="n">vmdesc</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;version&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">version_id</span><span class="p">);</span>
<span class="w">        </span><span class="n">json_start_array</span><span class="p">(</span><span class="n">vmdesc</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fields&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">field_exists</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">             </span><span class="n">field</span><span class="o">-&gt;</span><span class="n">field_exists</span><span class="p">(</span><span class="n">opaque</span><span class="p">,</span><span class="w"> </span><span class="n">version_id</span><span class="p">))</span><span class="w"> </span><span class="o">||</span>
<span class="w">            </span><span class="p">(</span><span class="o">!</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">field_exists</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">             </span><span class="n">field</span><span class="o">-&gt;</span><span class="n">version_id</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">version_id</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">first_elem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">opaque</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">field</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">n_elems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmstate_n_elems</span><span class="p">(</span><span class="n">opaque</span><span class="p">,</span><span class="w"> </span><span class="n">field</span><span class="p">);</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmstate_size</span><span class="p">(</span><span class="n">opaque</span><span class="p">,</span><span class="w"> </span><span class="n">field</span><span class="p">);</span>
<span class="w">            </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">old_offset</span><span class="p">,</span><span class="w"> </span><span class="n">written_bytes</span><span class="p">;</span>
<span class="w">            </span><span class="n">QJSON</span><span class="w"> </span><span class="o">*</span><span class="n">vmdesc_loop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmdesc</span><span class="p">;</span>

<span class="w">            </span><span class="n">trace_vmstate_save_state_loop</span><span class="p">(</span><span class="n">vmsd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">field</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">n_elems</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">VMS_POINTER</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">first_elem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="n">first_elem</span><span class="p">;</span>
<span class="w">                </span><span class="n">assert</span><span class="p">(</span><span class="n">first_elem</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">n_elems</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">size</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_elems</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">curr_elem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first_elem</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">                </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">                </span><span class="n">vmsd_desc_field_start</span><span class="p">(</span><span class="n">vmsd</span><span class="p">,</span><span class="w"> </span><span class="n">vmdesc_loop</span><span class="p">,</span><span class="w"> </span><span class="n">field</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">n_elems</span><span class="p">);</span>
<span class="w">                </span><span class="n">old_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qemu_ftell_fast</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">VMS_ARRAY_OF_POINTER</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">assert</span><span class="p">(</span><span class="n">curr_elem</span><span class="p">);</span>
<span class="w">                    </span><span class="n">curr_elem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="n">curr_elem</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">curr_elem</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="cm">/* if null pointer write placeholder and do not follow */</span>
<span class="w">                    </span><span class="n">assert</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">VMS_ARRAY_OF_POINTER</span><span class="p">);</span>
<span class="w">                    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmstate_info_nullptr</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">curr_elem</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">                                                   </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">VMS_STRUCT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmstate_save_state</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">field</span><span class="o">-&gt;</span><span class="n">vmsd</span><span class="p">,</span><span class="w"> </span><span class="n">curr_elem</span><span class="p">,</span>
<span class="w">                                             </span><span class="n">vmdesc_loop</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">VMS_VSTRUCT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmstate_save_state_v</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">field</span><span class="o">-&gt;</span><span class="n">vmsd</span><span class="p">,</span><span class="w"> </span><span class="n">curr_elem</span><span class="p">,</span>
<span class="w">                                               </span><span class="n">vmdesc_loop</span><span class="p">,</span>
<span class="w">                                               </span><span class="n">field</span><span class="o">-&gt;</span><span class="n">struct_version_id</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">field</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">curr_elem</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">field</span><span class="p">,</span>
<span class="w">                                     </span><span class="n">vmdesc_loop</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">error_report</span><span class="p">(</span><span class="s">&quot;Save of field %s/%s failed&quot;</span><span class="p">,</span>
<span class="w">                                 </span><span class="n">vmsd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">field</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vmsd</span><span class="o">-&gt;</span><span class="n">post_save</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">vmsd</span><span class="o">-&gt;</span><span class="n">post_save</span><span class="p">(</span><span class="n">opaque</span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="n">written_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qemu_ftell_fast</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">old_offset</span><span class="p">;</span>
<span class="w">                </span><span class="n">vmsd_desc_field_end</span><span class="p">(</span><span class="n">vmsd</span><span class="p">,</span><span class="w"> </span><span class="n">vmdesc_loop</span><span class="p">,</span><span class="w"> </span><span class="n">field</span><span class="p">,</span><span class="w"> </span><span class="n">written_bytes</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>

<span class="w">                </span><span class="cm">/* Compressed arrays only care about the first element */</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vmdesc_loop</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">vmsd_can_compress</span><span class="p">(</span><span class="n">field</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">vmdesc_loop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">VMS_MUST_EXIST</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">error_report</span><span class="p">(</span><span class="s">&quot;Output state validation failed: %s/%s&quot;</span><span class="p">,</span>
<span class="w">                        </span><span class="n">vmsd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">field</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">                </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">VMS_MUST_EXIST</span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">field</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vmdesc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">json_end_array</span><span class="p">(</span><span class="n">vmdesc</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmstate_subsection_save</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">vmsd</span><span class="p">,</span><span class="w"> </span><span class="n">opaque</span><span class="p">,</span><span class="w"> </span><span class="n">vmdesc</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vmsd</span><span class="o">-&gt;</span><span class="n">post_save</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">ps_ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmsd</span><span class="o">-&gt;</span><span class="n">post_save</span><span class="p">(</span><span class="n">opaque</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ps_ret</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>所以对于virtio-blk设备而言，保存的状态内容大概包括3部分：virtio-blk-pci配置空间信息，virtio-blk-pci队列信息，
还有virtio-blk信息等3个方面。</p>
<div class="highlight"><pre><span></span><code><span class="n">virtio_save</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">save_config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">virtio_pci_save_config</span><span class="p">()</span><span class="w">   </span><span class="cm">/* 保存virtio-blk-pci设备的配置空间 */</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="o">-&gt;</span><span class="n">save_queue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">virtio_pci_save_queue</span><span class="p">()</span><span class="w">    </span><span class="cm">/* 保存virtio-pci-blk保存队列 */</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vdc</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">virtio_blk_save_device</span><span class="p">()</span><span class="w">    </span><span class="cm">/* 保存virtio-blk信息 */</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">vmsd</span><span class="o">-&gt;</span><span class="n">pre_save</span>
<span class="p">}</span>
</code></pre></div>

<p>为了搞清楚每个设备到底保存了哪些东西，我打开了qemu在vmsate_save里面的trace，得到了一份trace日志。
日志详细记录了每个设备保存了哪些field，这个文件有点大，raw格式打开可以查看：<a href="../images/vmstate_tracelog.txt">vmstate_tracelog.txt</a>
从文件的头部很明显可以看出save了一个configuration结构（虚拟机配置文件）和一个timer结构，
其中timer有cpu_ticks_offset,unused,cpu_clock_offset登几个field。</p>
<div class="highlight"><pre><span></span><code>vmstate_save_state_top 0.000 pid=469556 idstr=b&#39;configuration&#39;
vmstate_save_state_pre_save_res 5.059 pid=469556 name=b&#39;configuration&#39; res=0x0
vmstate_save_state_loop 1.754 pid=469556 name=b&#39;configuration&#39; field=b&#39;len&#39; n_elems=0x1
vmstate_save_state_loop 2.217 pid=469556 name=b&#39;configuration&#39; field=b&#39;name&#39; n_elems=0x1

vmstate_save_state_top 1456114.395 pid=469556 idstr=b&#39;timer&#39;
vmstate_save_state_loop 1.911 pid=469556 name=b&#39;timer&#39; field=b&#39;cpu_ticks_offset&#39; n_elems=0x1
vmstate_save_state_loop 2.444 pid=469556 name=b&#39;timer&#39; field=b&#39;unused&#39; n_elems=0x1
vmstate_save_state_loop 1.046 pid=469556 name=b&#39;timer&#39; field=b&#39;cpu_clock_offset&#39; n_elems=0x1
</code></pre></div>

<p>虚拟机状态发生改变的时候回调函数<code>vm_state_notify</code>,</p>
<h2>3.2 Destination Behavior</h2>
<div class="highlight"><pre><span></span><code><span class="n">qmp_cmd_name</span><span class="o">:</span><span class="w"> </span><span class="n">qmp_capabilities</span><span class="o">,</span><span class="w"> </span><span class="k">arguments</span><span class="o">:</span><span class="w"> </span><span class="o">{}</span><span class="w">                                   </span>
<span class="n">qmp_cmd_name</span><span class="o">:</span><span class="w"> </span><span class="n">query</span><span class="o">-</span><span class="n">migrate</span><span class="o">-</span><span class="n">capabilities</span><span class="o">,</span><span class="w"> </span><span class="k">arguments</span><span class="o">:</span><span class="w"> </span><span class="o">{}</span><span class="w">                         </span>
<span class="n">qmp_cmd_name</span><span class="o">:</span><span class="w"> </span><span class="n">migrate</span><span class="o">-</span><span class="kd">set</span><span class="o">-</span><span class="n">capabilities</span><span class="o">,</span><span class="w"> </span><span class="k">arguments</span><span class="o">:</span><span class="w"> </span><span class="o">{</span><span class="s2">&quot;capabilities&quot;</span><span class="o">:</span><span class="w"> </span><span class="o">[{</span><span class="s2">&quot;state&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="o">,</span><span class="w"> </span><span class="s2">&quot;capability&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;events&quot;</span><span class="o">}]}</span>
<span class="n">qmp_cmd_name</span><span class="o">:</span><span class="w"> </span><span class="n">query</span><span class="o">-</span><span class="n">chardev</span><span class="o">,</span><span class="w"> </span><span class="k">arguments</span><span class="o">:</span><span class="w"> </span><span class="o">{}</span><span class="w">                                      </span>
<span class="n">qmp_cmd_name</span><span class="o">:</span><span class="w"> </span><span class="n">query</span><span class="o">-</span><span class="n">hotpluggable</span><span class="o">-</span><span class="n">cpus</span><span class="o">,</span><span class="w"> </span><span class="k">arguments</span><span class="o">:</span><span class="w"> </span><span class="o">{}</span><span class="w">                            </span>
<span class="n">qmp_cmd_name</span><span class="o">:</span><span class="w"> </span><span class="n">query</span><span class="o">-</span><span class="n">cpus</span><span class="o">-</span><span class="n">fast</span><span class="o">,</span><span class="w"> </span><span class="k">arguments</span><span class="o">:</span><span class="w"> </span><span class="o">{}</span><span class="w">                                    </span>
<span class="n">qmp_cmd_name</span><span class="o">:</span><span class="w"> </span><span class="n">query</span><span class="o">-</span><span class="n">iothreads</span><span class="o">,</span><span class="w"> </span><span class="k">arguments</span><span class="o">:</span><span class="w"> </span><span class="o">{}</span><span class="w">                                    </span>
<span class="n">qmp_cmd_name</span><span class="o">:</span><span class="w"> </span><span class="n">balloon</span><span class="o">,</span><span class="w"> </span><span class="k">arguments</span><span class="o">:</span><span class="w"> </span><span class="o">{</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="w"> </span><span class="mi">34359738368</span><span class="o">}</span><span class="w">                        </span>
<span class="n">qmp_cmd_name</span><span class="o">:</span><span class="w"> </span><span class="n">query</span><span class="o">-</span><span class="n">migrate</span><span class="o">-</span><span class="n">parameters</span><span class="o">,</span><span class="w"> </span><span class="k">arguments</span><span class="o">:</span><span class="w"> </span><span class="o">{}</span><span class="w">                           </span>
<span class="n">qmp_cmd_name</span><span class="o">:</span><span class="w"> </span><span class="n">migrate</span><span class="o">-</span><span class="kd">set</span><span class="o">-</span><span class="n">capabilities</span><span class="o">,</span><span class="w"> </span><span class="k">arguments</span><span class="o">:</span><span class="w"> </span><span class="o">{</span><span class="s2">&quot;capabilities&quot;</span><span class="o">:</span><span class="w"> </span><span class="o">[{</span><span class="s2">&quot;state&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="o">,</span><span class="w"> </span><span class="s2">&quot;capability&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;xbzrle&quot;</span><span class="o">},</span><span class="w"> </span><span class="o">{</span><span class="s2">&quot;state&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="o">,</span><span class="w"> </span><span class="s2">&quot;capability&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;auto-converge&quot;</span><span class="o">},</span><span class="w"> </span><span class="o">{</span><span class="s2">&quot;state&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="o">,</span><span class="w"> </span><span class="s2">&quot;capability&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;rdma-pin-all&quot;</span><span class="o">},</span><span class="w"> </span><span class="o">{</span><span class="s2">&quot;state&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="o">,</span><span class="w"> </span><span class="s2">&quot;capability&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;postcopy-ram&quot;</span><span class="o">},</span><span class="w"> </span><span class="o">{</span><span class="s2">&quot;state&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="o">,</span><span class="w"> </span><span class="s2">&quot;capability&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;compress&quot;</span><span class="o">},</span><span class="w"> </span><span class="o">{</span><span class="s2">&quot;state&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="o">,</span><span class="w"> </span><span class="s2">&quot;capability&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pause-before-switchover&quot;</span><span class="o">},</span><span class="w"> </span><span class="o">{</span><span class="s2">&quot;state&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="o">,</span><span class="w"> </span><span class="s2">&quot;capability&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;late-block-activate&quot;</span><span class="o">},</span><span class="w"> </span><span class="o">{</span><span class="s2">&quot;state&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="o">,</span><span class="w"> </span><span class="s2">&quot;capability&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;multifd&quot;</span><span class="o">}]}</span>
<span class="n">qmp_cmd_name</span><span class="o">:</span><span class="w"> </span><span class="n">migrate</span><span class="o">-</span><span class="kd">set</span><span class="o">-</span><span class="n">parameters</span><span class="o">,</span><span class="w"> </span><span class="k">arguments</span><span class="o">:</span><span class="w"> </span><span class="o">{</span><span class="s2">&quot;multifd-channels&quot;</span><span class="o">:</span><span class="w"> </span><span class="mi">4</span><span class="o">,</span><span class="w"> </span><span class="s2">&quot;tls-creds&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="o">,</span><span class="w"> </span><span class="s2">&quot;tls-hostname&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="o">}</span>
<span class="n">qmp_cmd_name</span><span class="o">:</span><span class="w"> </span><span class="n">migrate</span><span class="o">-</span><span class="n">incoming</span><span class="o">,</span><span class="w"> </span><span class="k">arguments</span><span class="o">:</span><span class="w"> </span><span class="o">{</span><span class="s2">&quot;uri&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;tcp:[::]:49152&quot;</span><span class="o">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">qmp_migrate_incoming</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">qemu_start_incoming_migration</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">tcp_start_incoming_migration</span>
<span class="w">            </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">socket_start_incoming_migration</span>
<span class="w">                </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">socket_accept_incoming_migration</span>
<span class="w">                    </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">migration_channel_process_incoming</span>
<span class="w">                        </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">migraiton_incoming_setup</span>
<span class="w">                            </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">migraiton_incoming_process</span>
<span class="w">                                </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">process_incoming_migration_co</span>
</code></pre></div>

<h2>4. Conclusion</h2>
<h2>References</h2>
<ol>
<li>https://www.qemu.org/docs/master/system/index.html</li>
</ol>


             
 
            
            
            







            <hr/>
<section>
    <h2>Related Posts</h2>
<ul class="related-posts-list">
<li><a href="https://kernelgo.org/live-migration-with-passthroughed-device.html" title="Live Migration with Passthroughed Device (Draft)">Live Migration with Passthroughed Device (Draft)</a></li>
</ul>
<hr />
</section>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2020-02-23T23:00:00+08:00">Sun 23 February 2020</time>

            <h4>Category</h4>
            <a class="category-link" href="https://kernelgo.org/categories.html#virtualization-ref">virtualization</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="https://kernelgo.org/tags.html#live-migration-ref">live-migration
                    <span class="superscript">1</span>
</a></li>
            </ul>
<h4>Contact</h4>
<div id="sidebar-social-link">
    <a href="https://github.com/fangying" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitHub" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1B1817"/><path fill="#fff" d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
    </a>
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>
    <div>
        <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title"> kernelgo"</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="https://kernelgo.org" property="cc:attributionName" rel="cc:attributionURL">Yori Fang</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.
    </div>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="https://kernelgo.org/theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>